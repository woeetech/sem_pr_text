VYSOKÃ‰ UÄŒENÃ TECHNICKÃ‰ V BRNÄš Fakulta elektrotechniky a komunikaÄnÃ­ch technologiÃ­

SEMESTRÃLNÃ PRÃCE

Brno, 2020

VojtÄ›ch LukÃ¡Å¡

VYSOKÃ‰ UÄŒENÃ TECHNICKÃ‰ V BRNÄš
BRNO UNIVERSITY OF TECHNOLOGY

FAKULTA ELEKTROTECHNIKY A KOMUNIKAÄŒNÃCH TECHNOLOGIÃ
FACULTY OF ELECTRICAL ENGINEERING AND COMMUNICATION

ÃšSTAV TELEKOMUNIKACÃ
DEPARTMENT OF TELECOMMUNICATIONS

MIDI PO ETHERNETU

SEMESTRÃLNÃ PRÃCE
SEMESTRAL THESIS

AUTOR PRÃCE
AUTHOR

VojtÄ›ch LukÃ¡Å¡

VEDOUCÃ PRÃCE
SUPERVISOR

Ing. OndÅ™ej Krajsa, Ph.D.

BRNO 2020

SemestrÃ¡lnÃ­ prÃ¡ce
bakalÃ¡Å™skÃ½ studijnÃ­ program Audio inÅ¾enÃ½rstvÃ­ specializace ZvukovÃ¡ produkce a nahrÃ¡vÃ¡nÃ­ Ãšstav telekomunikacÃ­ Student: VojtÄ›ch LukÃ¡Å¡ RoÄnÃ­k: 3 NÃZEV TÃ‰MATU: ID: 211572 AkademickÃ½ rok: 2020/21

MIDI po Ethernetu
POKYNY PRO VYPRACOVÃNÃ: NavrhnÄ›te a realizujte pÅ™Ã­pravek pro pÅ™enos protokolu MIDI po Ethernetu. PÅ™Ã­pravek bude mÃ­t dva vstupnÃ­ porty a dva vÃ½stupnÃ­ porty s moÅ¾nostÃ­ pÅ™epnutÃ­ do reÅ¾imu Thru. Data pÅ™enÃ¡Å¡enÃ¡ po Ethernetu pak budou v dalÅ¡Ã­m pÅ™Ã­pravku odeslÃ¡na na patÅ™iÄnÃ© MIDI porty. V rÃ¡mci semestrÃ¡lnÃ­ prÃ¡ce proveÄte nÃ¡vrh zaÅ™Ã­zenÃ­ a testovÃ¡nÃ­ dÃ­lÄÃ­ch ÄÃ¡stÃ­ s vyuÅ¾itÃ­m vÃ½vojovÃ©ho kitu. DOPORUÄŒENÃ LITERATURA: [1] LINSLEY HOOD, John. Audio Electronics. Kent: Elsevier Science, 1995. ISBN 9780750621816 [2] GUÃ‰RIN, Robert. VelkÃ¡ kniha MIDI: standardy, hardware, software. Brno: Computer Press, 2004, 340 s. ISBN 80-7226-985-2
TermÃ­n zadÃ¡nÃ­: 2.10.2020 TermÃ­n odevzdÃ¡nÃ­: 11.12.2020

VedoucÃ­ prÃ¡ce:

Ing. OndÅ™ej Krajsa, Ph.D.

doc. Ing. JiÅ™Ã­ Schimmel, Ph.D. pÅ™edseda rady studijnÃ­ho programu

UPOZORNÄšNÃ: Autor semestrÃ¡lnÃ­ prÃ¡ce nesmÃ­ pÅ™i vytvÃ¡Å™enÃ­ semestrÃ¡lnÃ­ prÃ¡ce poruÅ¡it autorskÃ¡ prÃ¡va tÅ™etÃ­ch osob, zejmÃ©na nesmÃ­ zasahovat nedovolenÃ½m zpÅ¯sobem do cizÃ­ch autorskÃ½ch prÃ¡v osobnostnÃ­ch a musÃ­ si bÃ½t plnÄ› vÄ›dom nÃ¡sledkÅ¯ poruÅ¡enÃ­ ustanovenÃ­ Â§ 11 a nÃ¡sledujÃ­cÃ­ch autorskÃ©ho zÃ¡kona Ä. 121/2000 Sb., vÄetnÄ› moÅ¾nÃ½ch trestnÄ›prÃ¡vnÃ­ch dÅ¯sledkÅ¯ vyplÃ½vajÃ­cÃ­ch z ustanovenÃ­ ÄÃ¡sti druhÃ©, hlavy VI. dÃ­l 4 TrestnÃ­ho zÃ¡konÃ­ku Ä.40/2009 Sb.

Fakulta elektrotechniky a komunikaÄnÃ­ch technologiÃ­, VysokÃ© uÄenÃ­ technickÃ© v BrnÄ› / TechnickÃ¡ 3058/10 / 616 00 / Brno

PROHLÃÅ ENÃ
ProhlaÅ¡uji, Å¾e svou semestrÃ¡lnÃ­ prÃ¡ci na tÃ©ma â€MIDI po Ethernetuâ€œ jsem vypracoval samostatnÄ› pod vedenÃ­m vedoucÃ­ho semestrÃ¡lnÃ­ prÃ¡ce a s pouÅ¾itÃ­m odbornÃ© literatury a dalÅ¡Ã­ch informaÄnÃ­ch zdrojÅ¯, kterÃ© jsou vÅ¡echny citovÃ¡ny v prÃ¡ci a uvedeny v seznamu literatury na konci prÃ¡ce. Jako autor uvedenÃ© semestrÃ¡lnÃ­ prÃ¡ce dÃ¡le prohlaÅ¡uji, Å¾e v souvislosti s vytvoÅ™enÃ­m tÃ©to semestrÃ¡lnÃ­ prÃ¡ce jsem neporuÅ¡il autorskÃ¡ prÃ¡va tÅ™etÃ­ch osob, zejmÃ©na jsem nezasÃ¡hl nedovolenÃ½m zpÅ¯sobem do cizÃ­ch autorskÃ½ch prÃ¡v osobnostnÃ­ch a/nebo majetkovÃ½ch a jsem si plnÄ› vÄ›dom nÃ¡sledkÅ¯ poruÅ¡enÃ­ ustanovenÃ­ S 11 a nÃ¡sledujÃ­cÃ­ch autorskÃ©ho zÃ¡kona Ä. 121/2000 Sb., o prÃ¡vu autorskÃ©m, o prÃ¡vech souvisejÃ­cÃ­ch s prÃ¡vem autorskÃ½m a o zmÄ›nÄ› nÄ›kterÃ½ch zÃ¡konÅ¯ (autorskÃ½ zÃ¡kon), ve znÄ›nÃ­ pozdÄ›jÅ¡Ã­ch pÅ™edpisÅ¯, vÄetnÄ› moÅ¾nÃ½ch trestnÄ›prÃ¡vnÃ­ch dÅ¯sledkÅ¯ vyplÃ½vajÃ­cÃ­ch z ustanovenÃ­ ÄÃ¡sti druhÃ©, hlavy VI. dÃ­l 4 TrestnÃ­ho zÃ¡konÃ­ku Ä. 40/2009 Sb.

Brno

...............

.................................. podpis autora

Obsah
Ãšvod 1 Protokol MIDI 1.1 HardwarovÃ¡ vrstva . 1.1.1 MIDI vÃ½stup 1.1.2 MIDI vstup . 1.2 SoftwarovÃ¡ vrstva . . 1.2.1 VÃ½jimky . . . 7 8 8 8 9 10 11 12 12 13 13 14 14 15 15 15 16 16 16 18 20 21 22 23

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

2 NÃ¡vrh pÅ™Ã­pravku 2.1 Hardware . . . . . . . . 2.2 Software . . . . . . . . . 2.2.1 DatabÃ¡ze spojenÃ­ 2.2.2 FormÃ¡t zprÃ¡vy . 2.2.3 SÃ­Å¥ovÃ¡ vrstva . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

3 PrÅ¯bÄ›h komunikace 3.1 PÅ™ipojenÃ­ k lokÃ¡lnÃ­ sÃ­ti . . . . . . 3.2 UpozornÄ›nÃ­ na vlastnÃ­ pÅ™Ã­tomnost 3.3 RozpoznÃ¡nÃ­ zaÅ™Ã­zenÃ­ na sÃ­ti . . . . 3.4 PÅ™ijetÃ­ MIDI zprÃ¡vy . . . . . . . . 3.5 PÅ™ijetÃ­ UDP zprÃ¡vy . . . . . . . . 4 SÃ­Å¥ovÃ½ ovladaÄ ZÃ¡vÄ›r Literatura Seznam symbolÅ¯, veliÄin a zkratek Seznam pÅ™Ã­loh

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

. . . . .

A Tabulky 24 A.1 MIDI status bajty . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24 A.2 MoE znaÄky . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25 B VÃ½pisy kÃ³du 26 B.1 VÃ½pis kÃ³du pro pÅ™Ã­jem a zpracovÃ¡nÃ­ MIDI zprÃ¡vy . . . . . . . . . . . 26

C ZÃ¡znamy z mÄ›Å™enÃ­ latence D Fotografie D.1 Fotografie testovacÃ­ho pÅ™Ã­pravku

27 28 . . . . . . . . . . . . . . . . . . . . 28

Seznam obrÃ¡zkÅ¯
1.1 1.2 1.3 1.4 2.1 2.2 4.1 4.2 4.3 C.1 C.2 D.1 SchÃ©ma MIDI vÃ½stupu [1]. . . . . . . . . . . . . . . . . . . . . . . . SchÃ©ma MIDI vstupu [1]. . . . . . . . . . . . . . . . . . . . . . . . . Bity obou druhÅ¯ MIDI bajtÅ¯ [1] . . . . . . . . . . . . . . . . . . . . Struktura zprÃ¡vy ZmÄ›na kontrolÃ©ru [1]. . . . . . . . . . . . . . . . . SchÃ©ma prototypu [3] . . . . . . . . . . . . . . . . . . . . . . . . . . KÃ³dovÃ¡nÃ­ zdrojovÃ©ho a cÃ­lovÃ©ho kanÃ¡lu v bajtu srcdstChannel . . . KonzolovÃ¡ aplikace MoE Matrix Editor â€“ ÃºvodnÃ­ obrazovka. . . . . KonzolovÃ¡ aplikace MoE Matrix Editor â€“ vytvÃ¡Å™enÃ­ spojenÃ­. . . . . KonzolovÃ¡ aplikace MoE Matrix Editor â€“ vyuÅ¾itÃ­ vklÃ¡dacÃ­ho makra. MÄ›Å™enÃ­ latence pro jeden aktivnÃ­ zÃ¡znam v databÃ¡zi spojenÃ­. . . . . MÄ›Å™enÃ­ latence pro Å¡estnÃ¡ct aktivnÃ­ch zÃ¡znamÅ¯ v databÃ¡zi spojenÃ­. . Fotografie testovacÃ­ho pÅ™Ã­pravku. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9 9 10 10 12 14 18 19 19 27 27 28

Ãšvod
Protokol MIDI1 je jiÅ¾ dlouhÃ¡ lÃ©ta zavedenÃ½m standardem nejen pro komunikaci mezi elektronickÃ½mi hudebnÃ­mi nÃ¡stroji, ale takÃ© pro Å™Ã­zenÃ­ studiovÃ© nebo scÃ©nickÃ© techniky, Äasovou synchronizaci dvou a vÃ­ce zaÅ™Ã­zenÃ­ a podobnÄ›. CÃ­lem tÃ©to prÃ¡ce je vyvinout hardwarovÃ½ pÅ™Ã­pravek s vlastnÃ­m softwarem, kterÃ½ adaptuje tento protokol pro pouÅ¾itÃ­ v rÃ¡mci poÄÃ­taÄovÃ© sÃ­tÄ›. Mimo elementÃ¡rnÃ­ pÅ™esun MIDI zprÃ¡v by mÄ›l poskytnout i komplexnÃ­ moÅ¾nosti smÄ›Å™ovÃ¡nÃ­ jednotlivÃ½ch vstupnÃ­ch a vÃ½stupnÃ­ch MIDI kanÃ¡lÅ¯. PrvnÃ­ kapitola je ve struÄnosti vÄ›novÃ¡na MIDI protokolu jako takovÃ©mu. Ve druhÃ© kapitole je nastÃ­nÄ›na konstrukce pÅ™Ã­pravku a v obrysech popsÃ¡n jeho program. TÅ™etÃ­ kapitola nabÃ­zÃ­ bliÅ¾Å¡Ã­ pohled na prÅ¯bÄ›h komunikace a ve ÄtvrtÃ© kapitole je popsÃ¡na funkÄnost sÃ­Å¥ovÃ©ho editoru, jehoÅ¾ hlavnÃ­ deviza tkvÃ­ ve schopnosti ovlÃ¡dat vÅ¡echny pÅ™Ã­pravku v sÃ­ti z jednoho mÃ­sta â€“ Å™Ã­dÃ­cÃ­ho PC.

1

Musical Instrument Digital Interface â€“ digitÃ¡lnÃ­ rozhranÃ­ hudebnÃ­ho nÃ¡stroje

7

1

Protokol MIDI

Tento protokol umoÅ¾Åˆuje pÅ™enos zejmÃ©na hudebnÃ­ch informacÃ­ mezi dvÄ›ma (i vÃ­ce) elektronickÃ½mi hudebnÃ­mi nÃ¡stroji, sekvencery, poÄÃ­taÄi a dalÅ¡Ã­mi pÅ™Ã­stroji. PÅ¯vodnÄ› byl zamÃ½Å¡len pro pouÅ¾itÃ­ â€v reÃ¡lnÃ©m Äaseâ€œ, tedy pÅ™i Å¾ivÃ© produkci. [1] S nÃ¡stupem modernÃ­ch DAW1 ale pÅ™iÅ¡la moÅ¾nost povely takÃ© nahrÃ¡vat, upravovat a znovu pÅ™ehrÃ¡vat. MIDI se vÅ¡ak netÃ½kÃ¡ vÃ½hradnÄ› hudby a hudebnÃ­ch dat. UmoÅ¾Åˆuje tÃ©Å¾ pÅ™enos kontrolnÃ­ch povelÅ¯ a synchronizaÄnÃ­ch znaÄek. PÅ™irozenÄ› se tedy rozÅ¡Ã­Å™ilo i do nahrÃ¡vacÃ­ch studiÃ­, divadel a dalÅ¡Ã­ch zaÅ™Ã­zenÃ­, kde umoÅ¾Åˆuje globÃ¡lnÃ­ Å™Ã­zenÃ­ jednotlivÃ½ch pÅ™ehrÃ¡vaÄÅ¯ nebo vzdÃ¡lenÃ© ovlÃ¡dÃ¡nÃ­ parametrÅ¯ Å™Ã­dÃ­cÃ­ch konzolÃ­.

1.1

HardwarovÃ¡ vrstva

Pro pÅ™enos MIDI dat se tradiÄnÄ› pouÅ¾Ã­vÃ¡ zÃ¡suvka a vidlice DIN 52 . Kabel mezi dvÄ›ma zaÅ™Ã­zenÃ­mi by nemÄ›l bÃ½t delÅ¡Ã­ neÅ¾ 15 m a tvoÅ™it by jej mÄ›la stÃ­nÄ›nÃ¡ kroucenÃ¡ dvojlinka. Toto stÃ­nÄ›nÃ­ by mÄ›lo bÃ½t pÅ™ipojeno k pinu 2 na obou koncÃ­ch. VÃ½mÄ›na informacÃ­ je realizovÃ¡na pomocÃ­ 5mA proudovÃ© smyÄky. PÅ™i protÃ©kÃ¡nÃ­ proudu je zaznamenÃ¡na logickÃ¡ 0, v opaÄnÃ©m pÅ™Ã­padÄ› logickÃ¡ 1. [1] PÅ™esnÃ¡ specifika obvodÅ¯ pro zpracovÃ¡nÃ­ pÅ™Ã­chozÃ­ch a odchozÃ­ch MIDI signÃ¡lÅ¯ upravuje kapitola Hardware z dokumentu [1]. Tato pasÃ¡Å¾ byla v roce 2014 aktualizovÃ¡na normou [2], kterÃ¡ adaptovala protokol i pro zaÅ™Ã­zenÃ­ s 3,3V logikou a pÅ™idÃ¡vÃ¡ dalÅ¡Ã­ prvky pro zamezenÃ­ zejmÃ©na RF3 interferencÃ­. V nÃ¡sledujÃ­cÃ­ch schÃ©matech bude vÅ¡ak zobrazeno originÃ¡lnÃ­ schÃ©ma z pÅ¯vodnÃ­ normy,

1.1.1

MIDI vÃ½stup

VÃ½stupnÃ­ port MIDI sbÄ›rnice je ve svÃ© podstatÄ› jednoduchÃ½. Z UART4 Äipu jsou pÅ™es napÄ›Å¥ovÃ© sledovaÄe nebo tranzistory vedeny logickÃ© impulzy na pin 5, zatÃ­mco na pin 4 je pÅ™ivedeno stÃ¡lÃ© napÄ›tÃ­. Pin 2 je v tomto pÅ™Ã­padÄ› uzemnÄ›n. [1] Podle aktualizaÄnÃ­ normy [2] je moÅ¾nÃ© pÅ™idat za kaÅ¾dÃ½ rezistor feritovÃ© jÃ¡dro pro zamezenÃ­ vysokofrekvenÄnÃ­ch interferencÃ­. V pÅ™Ã­padÄ› pouÅ¾itÃ­ zaÅ™Ã­zenÃ­ s 3,3V logikou jsou pak pouÅ¾ity rezistory s menÅ¡Ã­mi hodnotami odporÅ¯. Na obr. 1.1 je schÃ©ma k nahlÃ©dnutÃ­.
Digital Audio Workstation â€“ digitÃ¡lnÃ­ pracovnÃ­ stanice pro nÃ¡bÄ›r a Ãºpravu vÃ­cestopÃ©ho zÃ¡znamu. 2 Dnes je ÄastÄ›jÅ¡Ã­ vyuÅ¾itÃ­ USB sbÄ›rnice nebo technologie Bluetooth pro obousmÄ›rnÃ½ pÅ™enos. 3 Radio Frequency 4 Universal Asynchronous Receiver/Transmitter â€“ univerzÃ¡lnÃ­ asynchronnÃ­ pÅ™ijÃ­maÄ/vysÃ­laÄ.
1

8

220 Î©

5V
220 Î©

FROM UART

A
2 5 3 4 1

MIDI OUT Obr. 1.1: SchÃ©ma MIDI vÃ½stupu [1].

1.1.2

MIDI vstup

VstupnÃ­ port MIDI sbÄ›rnice je mnohem sloÅ¾itÄ›jÅ¡Ã­. Z obr. 1.2 je patrnÃ©, Å¾e s cÃ­lem eliminovat zemnÃ­ smyÄky, kterÃ© jsou ve zvukovÃ© technice nepÅ™Ã­pustnÃ©, je vstup kaÅ¾dÃ©ho MIDI zaÅ™Ã­zenÃ­ skrz optoÄlen galvanicky oddÄ›len. Z tÃ©hoÅ¾ dÅ¯vodu je takÃ© pin 2 â€“ na rozdÃ­l od vÃ½stupnÃ­ho portu â€“ zapojen naprÃ¡zdno (podle [1]). NÄ›kterÃ¡ zaÅ™Ã­zenÃ­ disponujÃ­ takÃ© vÃ½stupem MIDI THRU. Ten â€kopÃ­rujeâ€œ data ze vstupu MIDI IN a tak umoÅ¾Åˆuje komplexnÃ­ Å™etÄ›zenÃ­ zaÅ™Ã­zenÃ­ za sebou. Jeho schÃ©ma je totoÅ¾nÃ© s tÃ­m na obr. 1.1. AktualizaÄnÃ­ norma [2] pak umoÅ¾Åˆuje pÅ™idÃ¡nÃ­ feritovÃ½ch jader za piny 4 a 5, pÅ™es kondenzÃ¡tor nÃ­zkÃ© kapacity uzemnÄ›nÃ­ pinu 2 a pÅ™i pouÅ¾itÃ­ 3,3V logiky snÃ­Å¾enÃ­ odporu rezistoru na vstupu optoÄlenu.
5V
280 Î©

TO UART
220 Î©
2 5 3 4 1 1N914 6N138

MIDI IN

MIDI THRU Obr. 1.2: SchÃ©ma MIDI vstupu [1].

Bude-li do tohoto vstupu pÅ™ipojen vÃ½stup jinÃ©ho zaÅ™Ã­zenÃ­, kterÃ© vyÅ¡le logickou 1 objevÃ­ se na pinech 4 a 5 stejnÃ© napÄ›tÃ­, v obvodu tedy neprochÃ¡zÃ­ Å¾Ã¡dnÃ½ proud â€“ LED5 v optoÄlenu nesvÃ­tÃ­. VstupnÃ­ UART Äip pÅ™ijÃ­mÃ¡ logickou 1. VyÅ¡le-li jinÃ© zaÅ™Ã­zenÃ­ logickou 0, na pinu 5 poklesne napÄ›tÃ­ oproti pinu 4, LED v optoÄlenu se rozsvÃ­tÃ­, obvodem prochÃ¡zÃ­ proud a UART Äip pÅ™ijÃ­mÃ¡ logickou 1.
5

Light-Emiting Diode â€“ Dioda, kterÃ¡ vyzaÅ™uje viditelnÃ© svÄ›tlo.

9

1.2

SoftwarovÃ¡ vrstva

MIDI protokol pÅ™enÃ¡Å¡Ã­ informace (pÅ™Ã­kazy) po sÃ©riovÃ© lince pÅ™enosovou rychlostÃ­ 31250 bps. Komunikace je jednosmÄ›rnÃ¡, pro obousmÄ›rnou komunikaci je tÅ™eba vyuÅ¾Ã­t dvou rozhranÃ­ (vstupu a vÃ½stupu) na vÅ¡ech zÃºÄastnÄ›nÃ½ch zaÅ™Ã­zenÃ­ch. PÅ™Ã­kazy se sklÃ¡dajÃ­ z bajtÅ¯, jichÅ¾ rozeznÃ¡vÃ¡me dva typy: â€¢ STATUS BAJT v sobÄ› kÃ³duje druh pÅ™Ã­kazu (Nota stlaÄena, ZmÄ›na kontrolÃ©ru. . . ) a cÃ­lovÃ½ kanÃ¡l (1-16). â€¢ DATA BAJT vyjadÅ™uje hodnotu s jakou je pÅ™Ã­kaz posÃ­lÃ¡n (0-127). STATUS BAJT a a a b b b
(a) Bity STATUS BAJTU

1

b

0

c

DATA BAJT c c c c

c

c

(b) Bity DATA BAJTU

a b c

bity pro kÃ³dovÃ¡nÃ­ druhu zprÃ¡vy bity pro kÃ³dovÃ¡nÃ­ kanÃ¡lu bity pro kÃ³dovÃ¡nÃ­ hodnoty

Obr. 1.3: Bity obou druhÅ¯ MIDI bajtÅ¯ [1] Na obrÃ¡zku 1.3 je patrnÃ¡ struktura obou bajtÅ¯. Za pozornost stojÃ­ pÅ™edevÅ¡Ã­m jejich MSB6 : STATUS BAJT mÃ¡ MSB vÅ¾dy s hodnotou 1. Naproti tomu MSB DATA BAJTU je vÅ¾dy nulovÃ½. Pomineme-li vÃ½jimky, kaÅ¾dÃ½ pÅ™Ã­kaz zaÄÃ­nÃ¡ jednÃ­m STATUS BAJTEM, za nÃ­mÅ¾ nÃ¡sleduje jeden, nebo dva DATA BAJTY. Na obr. 1.4 je uvedena struktura ukÃ¡zkovÃ© zprÃ¡vy.

0xB0
1011 0000

0x01
0000 0001

0x36
0011 0110

Obr. 1.4: Struktura zprÃ¡vy ZmÄ›na kontrolÃ©ru [1]. Z prvnÃ­ho bajtu zprÃ¡vy z obr. 1.4 lze dekÃ³dovat druh a cÃ­lovÃ½ kanÃ¡l pÅ™Ã­kazu. JednÃ¡ se o Control Change - ZmÄ›na kontrolÃ©ru na kanÃ¡lu 1 7 DruhÃ½ bajt pÅ™edstavuje ÄÃ­slo kontrolÃ©ru (2 â€“ Modulation ) a tÅ™etÃ­ jeho hodnotu (54). Pro potÅ™eby tohoto semestrÃ¡lnÃ­ho projektu bude nutnÃ©, aby kaÅ¾dÃ½ pÅ™Ã­pravek dokÃ¡zal rozeznat kanÃ¡l k nÄ›mu pÅ™Ã­chozÃ­ MIDI zprÃ¡vy, popÅ™. jej pro dalÅ¡Ã­ pÅ™enos pozmÄ›nil. DATA BAJTY budou jen â€kopÃ­rovÃ¡nyâ€œ a nebude se do nich nijak zasahovÃ¡no.
6 7

Most Significant Bit â€“ NejvÃ½znamnÄ›jÅ¡Ã­ bit (vÄ›tÅ¡inou v bajtu). 00002 âˆ¼ kanÃ¡l 1 . . . 11112 âˆ¼ kanÃ¡l 16.

10

1.2.1

VÃ½jimky

Je tÅ™eba alespoÅˆ okrajovÄ› zmÃ­nit vÃ½jimeÄnÃ© stavy, kterÃ© v rÃ¡mci MIDI protokolu mohou nastat. V tÃ©to fÃ¡zi semestrÃ¡lnÃ­ prÃ¡ce tyto vÃ½jimky zatÃ­m nejsou oÅ¡etÅ™eny. Running Status Pracuje-li MIDI vysÃ­laÄ v tomto stavu, neposÃ­lÃ¡ STATUS BAJT v opakujÃ­cÃ­ se zprÃ¡vÄ› stejnÃ©ho druhu. PÅ™ijÃ­maÄ si tedy musÃ­ uloÅ¾it poslednÃ­ platnÃ½ STATUS BAJT do pamÄ›ti, kterou pÅ™emaÅ¾e, obdrÅ¾Ã­-li zprÃ¡vu s jinÃ½m, novÃ½m STATUS BAJTEM. Tento mÃ³d vÃ½raznÄ› Å¡etÅ™Ã­ pÅ™enesenÃ¡ data, zejmÃ©na je-li pouÅ¾it pÅ™i odesÃ­lÃ¡nÃ­ zprÃ¡vy ZmÄ›na kontrolÃ©ru kontinuÃ¡lnÃ­ch ovladaÄÅ¯. [1] ZprÃ¡vy Real-Time Tyto zprÃ¡vy slouÅ¾Ã­ pro synchronizaci MIDI zaÅ™Ã­zenÃ­, kterÃ© pracujÃ­ s Äasovou osou nebo Äasem obecnÄ›. SklÃ¡dajÃ­ se pouze z jedinÃ©ho bajtu a majÃ­ nejvyÅ¡Å¡Ã­ prioritu. PÅ™ijÃ­maÄ by mÄ›l bÃ½t pÅ™ipraven i na to, Å¾e je obdrÅ¾Ã­ uprostÅ™ed standardnÃ­ zprÃ¡vy nebo SysEx zprÃ¡vy. [1] ZprÃ¡vy SysEx SysEx (System Exlusive ) zprÃ¡vy se sklÃ¡dajÃ­ z vÄ›tÅ¡Ã­ho a libovolnÃ©ho poÄtu bajtÅ¯. Jsou vÃ­ceÃºÄelovÃ© a univerzÃ¡lnÃ­, pouÅ¾Ã­vajÃ­ se napÅ™Ã­klad pro posun na ÄasovÃ© ose (komplementÃ¡rnÄ› ke zprÃ¡vÃ¡m Real-Time), MSC8 apod. [1]

MIDI Show Control â€“ subprotokol pro ovlÃ¡dÃ¡nÃ­ scÃ©nickÃ© techniky, zejmÃ©na pomocÃ­ pÅ™Ã­kazÅ¯ GO, STOP, popÅ™. RESUME. [1]

8

11

2

NÃ¡vrh pÅ™Ã­pravku

V rÃ¡mci semestrÃ¡lnÃ­ prÃ¡ce byl vytvoÅ™en prototyp zaÅ™Ã­zenÃ­ na platformÄ› Arduino UNO, kterÃ¡ disponuje Äipem ATMEL ATmega 328P. Arduinu sekunduje Ethernet Shield V1, kterÃ½ je osazen Äipem WizNet W5100. Tento pÅ™Ã­pravek umoÅ¾Åˆuje vÃ½mÄ›nu MIDI pÅ™Ã­kazÅ¯ pÅ™es lokÃ¡lnÃ­ sÃ­Å¥, vyuÅ¾Ã­vÃ¡ prvnÃ­ ÄtyÅ™i vrstvy ISO/OSI modelu. ZÃ¡roveÅˆ, pomocÃ­ sÃ­Å¥ovÃ©ho editoru (kapitola 4), poskytuje pokroÄilÃ© moÅ¾nosti smÄ›rovÃ¡nÃ­ jednotlivÃ½ch MIDI kanÃ¡lÅ¯ napÅ™Ã­Ä dalÅ¡Ã­mi pÅ™Ã­pravky v sÃ­ti.

2.1

Hardware
5V 1 2 8 7

í µí±…2 Arduino
5

í µí±…1

6N138
3 4 6 5

WizNet
GND

í µí±…4

í µí±…3

4

2 5 3 4 1 5 3

2 4 1

MIDI IN
í µí±…1

MIDI OUT í µí±…3 220 Î© í µí±…2 10 kÎ© í µí±…4 470 Î© 220 Î©

Obr. 2.1: SchÃ©ma prototypu [3] Na obr. 2.1 je patrnÃ© schÃ©ma pÅ™Ã­pravku. Je vyuÅ¾ito standardnÃ­ zapojenÃ­ MIDI vstupu a vÃ½stupu v souladu se schÃ©maty na obr. 1.1 a 1.2. Jak jiÅ¾ bylo Å™eÄeno v kapitole 1, MIDI vyuÅ¾Ã­vÃ¡ pro komunikaci sÃ©riovou linku. V tomto pÅ™Ã­padÄ› je vstupnÃ­ linka zapojena k Arduinu na pinu 4 a vÃ½stupnÃ­ k pinu 51 . WizNet Shield zprostÅ™edkovÃ¡vÃ¡ pÅ™Ã­pravku standardnÃ­ ethernetovÃ© rozhranÃ­ v podobÄ› zÃ¡suvky typu RJ45, ovlÃ¡dacÃ­ho mikrokontrolÃ©ru a takÃ© pÅ™ipravenÃ½ch softwarovÃ½ch knihoven.
1

Arduino umoÅ¾Åˆuje softwarovÃ© pÅ™epnutÃ­ pinÅ¯ z reÅ¾imu vÃ½stupu na reÅ¾im vstup a naopak.

12

PÅ™Ã­pravek je v tÃ©to fÃ¡zi vÃ½voje napÃ¡jen prostÅ™ednictvÃ­m USB sbÄ›rnice Arduina napÄ›tÃ­m 5 V. VÅ¡echny souÄÃ¡stky jsou zatÃ­m vsazeny do nepÃ¡jivÃ©ho kontaktnÃ­ho pole. Fotografie protoypu jsou pÅ™iloÅ¾eny k nahlÃ©dnutÃ­ v TODO!

2.2

Software

Software pÅ™Ã­pravku byl vyvÃ­jen za ÃºÄelem maximalizace variability smÄ›Å™ovÃ¡nÃ­ MIDI pÅ™Ã­kazÅ¯. Na funkÄnÃ­ rovinÄ› je inspirovÃ¡n systÃ©mem Dante, kterÃ½ se pouÅ¾Ã­vÃ¡ pro pÅ™enos zvukovÃ©ho signÃ¡lu pÅ™es poÄÃ­taÄovou sÃ­Å¥. Dante umoÅ¾Åˆuje pokroÄilÃ© smÄ›Å™ovÃ¡nÃ­ signÃ¡lÅ¯ napÅ™Ã­Ä sÃ­Å¥ovÃ½mi zaÅ™Ã­zenÃ­mi, ovlÃ¡danÃ© pomocÃ­ pÅ™ehlednÃ© matice na ovlÃ¡dacÃ­m PC. Do tÃ©to fÃ¡ze by mÄ›l bÃ½t vyvinut i systÃ©m MoE2 . PÅ™Ã­pravek pracuje s dvÄ›ma typy zprÃ¡v: PÅ™Ã­chozÃ­, odchozÃ­ MIDI zprÃ¡vy, kterÃ© se tÃ½kajÃ­ hardwarovÃ© sbÄ›rnice (tedy pÅ™Ã­mo pinÅ¯ 4 a 5 z obr. 2.1) â€“ dÃ¡le jen â€MIDI zprÃ¡vyâ€œ â€“ a pÅ™Ã­chozÃ­, odchozÃ­ UDP zprÃ¡vy, kterÃ© se tÃ½kajÃ­ pouze ethernetovÃ©ho rozhranÃ­ zprostÅ™edkovanÃ©m WizNet Shieldem â€“ dÃ¡le jen â€UDP zprÃ¡vyâ€œ.

2.2.1

DatabÃ¡ze spojenÃ­

S cÃ­lem docÃ­lit jiÅ¾ zmiÅˆovanÃ© velkÃ© variability ve smÄ›Å™ovÃ¡nÃ­ zprÃ¡v napÅ™Ã­Ä pÅ™Ã­pravky byla do zdrojovÃ©ho kÃ³du implementovÃ¡na tzv. databÃ¡ze spojenÃ­ subscriptions[]:
typedef struct subscription { byte srcdstChannel ; byte dstIPnib ; } _subscriptions [ MAX_SUBS ];

Toto pole struktur subscription je pro MoE protokol zÃ¡sadnÃ­. Jedno â€spojenÃ­â€œ, tedy jeden prvek v tohoto pole, propojuje jeden MIDI kanÃ¡l lokÃ¡lnÃ­ho zaÅ™Ã­zenÃ­ s jednÃ­m MIDI kanÃ¡lem cÃ­lovÃ©ho zaÅ™Ã­zenÃ­. Toto pole si lze pÅ™edstavit jako virtuÃ¡lnÃ­ patchbay. Jeden patch-kabel odpovÃ­dÃ¡ jednomu prvku v poli (zÃ¡znamu v databÃ¡zi). KaÅ¾dÃ½ zÃ¡znam je tvoÅ™en dvÄ›ma bajty: 1. srcdstChannel v sobÄ› kÃ³duje zdrojovÃ½ MIDI kanÃ¡l, kterÃ½ se tÃ½kÃ¡ lokÃ¡lnÃ­ho zaÅ™Ã­zenÃ­, a cÃ­lovÃ½ MIDI kanÃ¡l â€“ ten se tÃ½kÃ¡ zaÅ™Ã­zenÃ­ cÃ­lovÃ©ho. â€KÃ³dovÃ¡nÃ­â€œ je uskuteÄnÄ›no zpÅ¯sobem vyobrazenÃ½m na obr. 2.2. Jeden kanÃ¡l je vyjÃ¡dÅ™en pomocÃ­ ÄtyÅ™ bitÅ¯ (viz kapitolu 1.2), jeden bajt tedy â€pojmeâ€œ vyjadÅ™enÃ­ pÅ™esnÄ› dvou kanÃ¡lÅ¯. 2. dstIPnib vyjadÅ™uje poslednÃ­ bajt IP adresy cÃ­lovÃ©ho zaÅ™Ã­zenÃ­ (viz tÃ©Å¾ sekci 2.2.3)
2

MIDI over Ethernet â€“ MIDI po Ethernetu

13

0
âŸ

srcdstChannel 1 1 0 1 0 1
â zdroj âŸ â cÃ­l

1

Obr. 2.2: KÃ³dovÃ¡nÃ­ zdrojovÃ©ho a cÃ­lovÃ©ho kanÃ¡lu v bajtu srcdstChannel Tato databÃ¡ze je pÅ™i kaÅ¾dÃ©m pÅ™ijetÃ­ MIDI zprÃ¡vy prochÃ¡zena. Pro pÅ™esnÃ½ prÅ¯bÄ›h programu viz 3.4 resp. B.1

2.2.2

FormÃ¡t zprÃ¡vy

Pro optimÃ¡lnÃ­ komunikaci zaÅ™Ã­zenÃ­ mezi sebou bylo nutnÃ© zapouzdÅ™it MIDI pÅ™Ã­kazy do MoE datagramu. Tento datagram se sklÃ¡dÃ¡ ze ÄtyÅ™ bajtÅ¯, z ÄehoÅ¾ prvnÃ­ je vyhrazen MoE znaÄce a zbylÃ© tÅ™i samotnÃ© MIDI zprÃ¡vÄ› nebo jinÃ½m datÅ¯m. Tabulku vÅ¡ech dosavadnÄ› implementovanÃ½ch MoE znaÄek lze nalÃ©zt v pÅ™Ã­loze A.2. Podle hodnoty tÃ©to znaÄky se pÅ™Ã­pravek k danÃ© MoE zprÃ¡vÄ› zachovÃ¡. Ku pÅ™Ã­kladu pÅ™Ã­chozÃ­ zprÃ¡va

0xA3, 0x90, 0x45, 0x7F,
bude interpretovÃ¡na jako okamÅ¾itÃ© odeslÃ¡nÃ­ MIDI zprÃ¡vy na sÃ©riovou sbÄ›rnici. Na zprÃ¡vu

0x08, 0x08, 0x08, 0x08,
bude pÅ™Ã­pravek zase reagovat zaslÃ¡nÃ­m svÃ© databÃ¡ze spojenÃ­ na adresu odesÃ­latele atp.

2.2.3

SÃ­Å¥ovÃ¡ vrstva

Tento MoE datagram je nÃ¡slednÄ› zapouzdÅ™en do UDP3 datagramu. Pro sÃ­Å¥ovou komunikaci byl vybrÃ¡n protokol UDP z dÅ¯vodu jeho â€peer2peerâ€œ architektury, kterÃ¡ je k tomuto projektu mnohem vhodnÄ›jÅ¡Ã­ neÅ¾ â€client-serverâ€œ, kterou poskytuje protokol TCP. Komunikace probÃ­hÃ¡ na portu 50 000. MoE zaÅ™Ã­zenÃ­ jsou schopna pÅ™ipojit se do lokÃ¡lnÃ­ sÃ­tÄ› s pevnÄ› nestavenou IP adresou4 , nebo zaÅ¾Ã¡dat o pÅ™idÄ›lenÃ­ IP adresy DHCP server. Tato sÃ­Å¥ vÅ¡ak musÃ­ mÃ­t masku 255.255.255.0 â€“ zaÅ™Ã­zenÃ­ se z ÃºspornÃ½ch dÅ¯vodÅ¯ navzÃ¡jem rozliÅ¡ujÃ­ pouze poslednÃ­m bajtem IP adresy (jak je popsÃ¡no v sekci 2.2.1).
User Datagram Protocol â€“ jednoduchÃ½ sÃ­Å¥ovÃ½ protokol, kterÃ½ umoÅ¾Åˆuje vÃ½mÄ›nu zprÃ¡v â€hostto-hostâ€œ [4]. 4 Tato IP adresa je zatÃ­m nastavitelnÃ¡ pouze ve zdrojovÃ©m kÃ³du.
3

14

3

PrÅ¯bÄ›h komunikace

V tÃ©to kapitole bude popsÃ¡n prÅ¯bÄ›h pÅ™ipojenÃ­ pÅ™Ã­pravku k sÃ­ti, automatickÃ© rozpoznÃ¡nÃ­ a zachÃ¡zenÃ­ s pÅ™ijatÃ½mi MIDI a UDP zprÃ¡vami, spolu s reakcemi na pÅ™Ã­kazy odeslanÃ© sÃ­Å¥ovÃ½m editorem.

3.1

PÅ™ipojenÃ­ k lokÃ¡lnÃ­ sÃ­ti

KaÅ¾dÃ©mu pÅ™Ã­pravku byla do prvnÃ­ch Å¡esti bajtÅ¯ EEPROM pamÄ›ti uloÅ¾ena unikÃ¡tnÃ­ MAC adresa. PÅ™i zapnutÃ­ a nÃ¡slednÃ© inicializaci je adresa naÄtena a pÅ™iÅ™azena. Nejprve probÄ›hne pokus o zÃ­skÃ¡nÃ­ IP adresy pomocÃ­ DHCP serveru sÃ­tÄ›. V pÅ™Ã­padÄ› neÃºspÄ›chu pouÅ¾ije pÅ™Ã­pravek napevno nastavenou IP adresu. DÃ­ky knihovnÄ› EthernetUdp.h jsou vÃ½Å¡e zmÃ­nÄ›nÃ© operace otÃ¡zkou pouze nÄ›kolika mÃ¡lo Å™Ã¡dkÅ¯:
if ( Ethernet . begin ()) { // DHCP server zd Ã¡ rn Ä› p Å™ id Ä› lil za Å™ Ã­ zen Ã­ IP adresu Serial . println ( Ethernet . localIP ()); } else { Ethernet . begin ( _myMac , _userIP ); // P Å™ id Ä› len Ã­ IP adresy napevno Serial . println ( Ethernet . localIP ()); }

3.2

UpozornÄ›nÃ­ na vlastnÃ­ pÅ™Ã­tomnost

Ihned po zdÃ¡rnÃ©m pÅ™ipojenÃ­ k lokÃ¡lnÃ­ sÃ­ti je vyslÃ¡na zprÃ¡va beacon, jejÃ­Å¾ ÃºÄel je upozornit vÅ¡echna zaÅ™Ã­zenÃ­ v lokÃ¡lnÃ­ sÃ­ti na vlastnÃ­ pÅ™Ã­tomnost. ZprÃ¡va se sklÃ¡dÃ¡ ze ÄtyÅ™ bajtÅ¯:

0xFF, 0xFF, 0xFF, 0xFF
a je poslÃ¡na na broadcast adresu sÃ­tÄ›.
_broadcastIP = Ethernet . localIP (); _broadcastIP [3] = 255; EthernetUdp eUDP ; eUDP . begin ( MOE_PORT );

15

eUDP . beginPacket ( _broadcastIP , MOE_PORT ); eUDP . write ( _beacon , sizeof ( _beacon )); eUDP . endPacket ();

3.3

RozpoznÃ¡nÃ­ zaÅ™Ã­zenÃ­ na sÃ­ti

V pÅ™Ã­padÄ› pÅ™ijetÃ­ zprÃ¡vy beacon je rozpoznÃ¡na IP adresa odesÃ­latele a vytvoÅ™en novÃ½ zÃ¡znam do databÃ¡ze spojenÃ­ subscriptions. V tÃ©to fÃ¡zi projektu pÅ™Ã­pravek napevno pÅ™iÅ™azuje kanÃ¡l 1 lokÃ¡lnÃ­ pÅ™Ã­chozÃ­ MIDI sbÄ›rnice kanÃ¡lu 1 vÃ½stupnÃ­ MIDI sbÄ›rnice cÃ­lovÃ©ho zaÅ™Ã­zenÃ­. UnikÃ¡tnost tÃ©to zprÃ¡vy v rÃ¡mci bÄ›hu programu mÃ¡ vÅ¡ak velice negativnÃ­ efekt: ZaÅ™Ã­zenÃ­, kerÃ© je do sÃ­tÄ› pÅ™ipojeno jako poslednÃ­ nepÅ™ijme Å¾Ã¡dnou zprÃ¡vu beacon, do svÃ© databÃ¡ze si tedy Å¾Ã¡dnÃ© spojenÃ­ nepÅ™idÃ¡. Z toho dÅ¯vodu byl vyvinut sÃ­Å¥ovÃ½ editor, kterÃ½ umoÅ¾Åˆuje pÅ™idÃ¡vat a mazat zÃ¡znamy do databÃ¡zÃ­ spojenÃ­ vÅ¡ech pÅ™Ã­pravkÅ¯ kdykoliv za bÄ›hu programu.

3.4

PÅ™ijetÃ­ MIDI zprÃ¡vy

PÅ™i pÅ™ijÃ­mÃ¡nÃ­ MIDI zprÃ¡vy je kontrolovÃ¡n vstupnÃ­ buffer sÃ©riovÃ© sbÄ›rnice pinu 5. Pokud jsou v bufferu pÅ™esnÄ› tÅ™i bajty, jsou postupnÄ› pÅ™eÄteny a uloÅ¾eny do pamÄ›ti. V dalÅ¡Ã­m kroku je nutnÃ© dekÃ³dovat kanÃ¡l tÃ©to MIDI zprÃ¡vy z DATA BAJTU â€“ tuto â€extrakciâ€œ lze vyÅ™eÅ¡it pomocÃ­ bitovÃ©ho maskovÃ¡nÃ­. Takto zÃ­skanÃ½ bajt je pak porovnÃ¡vÃ¡n s prvnÃ­m nibblem bajtu srcdstChannel kaÅ¾dÃ©ho zÃ¡znamu databÃ¡ze subscriptions. Dojde-li ke shodÄ›, zaÄÃ­nÃ¡ konstrukce odchozÃ­ zprÃ¡vy podle dalÅ¡Ã­ch informacÃ­ v odpovÃ­dajÃ­cÃ­m zÃ¡znamu databÃ¡ze spojenÃ­. V tomto bodÄ› je dÅ¯leÅ¾itÃ© zmÃ­nit, Å¾e druhÃ½ nibble DATA BAJTU â€“ kanÃ¡l â€“ je zmÄ›nÄ›n, aby bylo zaruÄeno, Å¾e z MIDI sbÄ›rnice cÃ­lovÃ©ho zaÅ™Ã­zenÃ­ budou proudit zprÃ¡vy na kanÃ¡lech odpovÃ­dajÃ­cÃ­ch databÃ¡zi spojenÃ­. VÃ½pis kÃ³du je k dispozici jako pÅ™Ã­loha B.1

3.5

PÅ™ijetÃ­ UDP zprÃ¡vy

Ve okamÅ¾iku pÅ™Ã­jmu UDP zprÃ¡vy je nejprve nutnÃ© rozliÅ¡it jejÃ­ prvnÃ­ bajt â€“ ten urÄuje ÃºÄel zprÃ¡vy. Toto se uskuteÄÅˆuje pomocÃ­ jednoduchÃ©ho vÄ›tvenÃ­ switch.
if ( eUDP . parsePacket ()) { eUDP . readByte ( _incomingUDP . 4); switch ( _incomingUDP [0]) {...} }

16

Pro pÅ™Ã­klad jsou zde uvedeny dvÄ› reakce na danÃ© druhy pÅ™Ã­chozÃ­ch zprÃ¡v v souladu s tabulkou A.2. Tento kÃ³d je obsahem vÄ›tvenÃ­ switch z pÅ™edchozÃ­ho odstavce.
// ... case 0 x08 : // dotaz Å™ Ã­ d Ã­ c Ã­ ho PC na z Ã¡ znamy // v datab Ã¡ zi spojen Ã­ sendSubs ( eUDP . remoteIP ()); break ;

// P Å™ Ã­ jem t Å™ Ã­ bajtov Ã© MIDI zpr Ã¡ vy // a z Ã¡ pis na sb Ä› rnici midiSerial . write ( _incomingUDP [1]); midiSerial . write ( _incomingUDP [2]); midiSerial . write ( _incomingUDP [3]); break ; // ...

case 0 xA3 :

17

4

SÃ­Å¥ovÃ½ ovladaÄ

Pro centrÃ¡lnÃ­ dÃ¡lkovÃ© ovlÃ¡dÃ¡nÃ­ databÃ¡zÃ­ spojenÃ­ na jednotlivÃ½ch pÅ™Ã­pravcÃ­ch v sÃ­ti byl vytvoÅ™en jednoduchÃ½ program v jazyce Python, kterÃ½ je nutnÃ© spustit na PC, kterÃ½ je pÅ™ipojen ve stejnÃ© sÃ­ti jako vÅ¡echny pÅ™Ã­pravky. V dobÄ› odevzdÃ¡vÃ¡nÃ­ tÃ©to semestrÃ¡lnÃ­ prÃ¡ce existuje ovladaÄ pouze jako konzolovÃ½ skript, v plÃ¡nu je vÅ¡ak vytvoÅ™it i uÅ¾ivatelsky mnohem pÅ™Ã­vÄ›tivÄ›jÅ¡Ã­ aplikaci s grafickÃ½m rozhranÃ­m.

Obr. 4.1: KonzolovÃ¡ aplikace MoE Matrix Editor â€“ ÃºvodnÃ­ obrazovka. Za bÄ›hu programu mÃ¡ uÅ¾ivatel na vÃ½bÄ›r ze ÄtyÅ™ pÅ™Ã­kazÅ¯. Na konzoli vytiskne vÅ¡echna zaÅ™Ã­zenÃ­ v sÃ­ti a jejich aktuÃ¡lnÃ­ spojenÃ­. add PÅ™idÃ¡ vybranÃ©mu zaÅ™Ã­zenÃ­ zÃ¡znam do databÃ¡ze spojenÃ­ subscriptions. del VymaÅ¾e vybranÃ©mu zaÅ™Ã­zenÃ­ zÃ¡znam z databÃ¡ze spojenÃ­. reload VyÅ¾Ã¡dÃ¡ si po vÅ¡ech zaÅ™Ã­zenÃ­ch na sÃ­ti aktualizaci jejich databÃ¡zÃ­ spojenÃ­. print Pro zjednoduÅ¡enÃ­ je pÅ™idÃ¡no â€makroâ€œ, kterÃ© se spouÅ¡tÃ­ zadÃ¡nÃ­m hodnoty 255 do pole pro cÃ­lovÃ½ kanÃ¡l zaÅ™Ã­zenÃ­. V tomto pÅ™Ã­padÄ› bude namÃ­sto jedinÃ©ho spojenÃ­ vytvoÅ™eno Å¡estnÃ¡ct unikÃ¡tnÃ­ch spojenÃ­ tak, aby jeden MIDI kanÃ¡l zdrojovÃ©ho zaÅ™Ã­zenÃ­ pÅ™ijÃ­malo vÅ¡ech Å¡estnÃ¡ct kanÃ¡lÅ¯ zaÅ™Ã­zenÃ­ cÃ­lovÃ©ho. Je tÅ™eba dodat, Å¾e toto makro reÃ¡lnÄ› vyuÅ¾itelnÃ© nenÃ­, velice vÅ¡ak usnadnÃ­ prÃ¡ci pÅ™i testovacÃ­ch a mÄ›Å™Ã­cÃ­ch aktivitÃ¡ch. Analogicky k tomuto makru funduje i pÅ™Ã­kaz del s parametrem 255 u hodnoty destinationChannel.

18

Obr. 4.2: KonzolovÃ¡ aplikace MoE Matrix Editor â€“ vytvÃ¡Å™enÃ­ spojenÃ­.

Obr. 4.3: KonzolovÃ¡ aplikace MoE Matrix Editor â€“ vyuÅ¾itÃ­ vklÃ¡dacÃ­ho makra.

19

ZÃ¡vÄ›r
VÃ½stupem tÃ©to semestrÃ¡lnÃ­ prÃ¡ce je funkÄnÃ­ pÅ™Ã­pravek, kterÃ½ disponuje ethernetovÃ½m a vstupnÃ­m i vÃ½stupnÃ­m MIDI rozhranÃ­m. PÅ™Ã­pravek se automaticky pÅ™ipojÃ­ do poÄÃ­taÄovÃ© sÃ­tÄ› a dÃ¡le funguje jiÅ¾ autonomnÄ›. DokÃ¡Å¾e pÅ™ijmout MIDI zprÃ¡vu, pÅ™eformÃ¡tovat ji v souladu s danÃ½m zÃ¡znamem databÃ¡ze spojenÃ­ a s vyuÅ¾itÃ­m UDP protokolu poslat sprÃ¡vnÃ©mu pÅ™Ã­jemci. DatabÃ¡ze spojenÃ­ je taktÃ©Å¾ editovatelnÃ¡ na dÃ¡lku pomocÃ­ programu MoE Matrix Editor. StÃ¡le vÅ¡ak existuje mnoho prostoru pro optimalizaci. Pokud pÅ™Ã­pravek obdrÅ¾Ã­ vÃ­ce neÅ¾ dvÄ› MIDI zprÃ¡vy tÄ›snÄ› za sebou, pÅ™estane pÅ™ijÃ­mat jakÃ©koliv dalÅ¡Ã­ bajty a jeho funkÄnost je do restartu pÅ™eruÅ¡ena. Absence implementace oÅ¡etÅ™enÃ­ vÃ½jimek (dle kapitoly 1.2.1) zase prozatÃ­m brÃ¡nÃ­ vyuÅ¾itÃ­ pÅ™Ã­pravkÅ¯ tam, kde je pÅ™Ã­jem zprÃ¡v v mÃ³du Running Status nebo SysEx standardem. Jako uspokojivÃ© lze vÅ¡ak vnÃ­mat dosaÅ¾enÃ© hodnoty latence mezi pÅ™ijetÃ­m MIDI zprÃ¡vy na sÃ©riovÃ© sbÄ›rnici jednoho zaÅ™Ã­zenÃ­ a odeslÃ¡nÃ­ tÃ©Å¾ zprÃ¡vy na sÃ©riovou sbÄ›rnici zaÅ™Ã­zenÃ­ druhÃ©ho. Komunikace mezi samotnÃ½mi zaÅ™Ã­zenÃ­mi samozÅ™ejmÄ› probÃ­hala prostÅ™ednictvÃ­m poÄÃ­taÄovÃ© sÃ­tÄ›. Dle pÅ™Ã­lohy C.1 vykazuje dolnÃ­ hranice celkovÃ© latence MoE Å™eÅ¡enÃ­ 2,18 ms v pÅ™Ã­padÄ› jedinÃ©ho zÃ¡znamu v databÃ¡zi spojenÃ­. S kaÅ¾dÃ½m dalÅ¡Ã­m zÃ¡znamem pak latence pÅ™irozenÄ› roste. MaximÃ¡lnÃ­ namÄ›Å™enÃ¡ hodnota latence (mezi prvnÃ­ pÅ™ijatou a poslednÃ­ odeslanou zprÃ¡vou) pak dosahovala 20,92 ms. PÅ™i Å¾ivÃ© hudebnÃ­ produkci s vyuÅ¾itÃ­m MIDI klÃ¡vesovÃ©ho nÃ¡stroje by nemÄ›la celkovÃ¡ latence pÅ™esÃ¡hnout 5 ms. S touto premisou lze prohlÃ¡sit, Å¾e MoE Å™eÅ¡enÃ­ by mohlo bÃ½t za urÄitÃ½ch podmÃ­nek pouÅ¾itelnÃ© i pro ÄasovÄ› nÃ¡roÄnÄ›jÅ¡Ã­ podmÃ­nky.

20

Literatura
[1] THE MIDI MANUFACTURERS ASSOCIATION. MIDI 1.0 Detailed Specification. Document Version 4.2.1. Los Angeles, CA: MMA, 1996. [2] MMA TECHNICAL STANDARDS BOARD/AMEI MIDI COMMITTEE. MIDI 1.0 Electrical Specification Update. 2014. [3] GHASSAEI, Amanda. Send and Receive MIDI With Arduino [online]. [cit. 1. 12. 2020]. DostupnÃ© z URL: <https://www.instructables.com/ Send-and-Receive-MIDI-with-Arduino/>. [4] MNEIMNEH, Saad. Computer Networks UDP and TCP. Hunter College of CUNY. New York. 2008.

21

Seznam symbolÅ¯, veliÄin a zkratek
MIDI Musical Instrument Digital Interface â€“ digitÃ¡lnÃ­ rozhranÃ­ hudebnÃ­ho nÃ¡stroje Digital Audio Workstation â€“ digitÃ¡lnÃ­ pracovnÃ­ stanice pro nÃ¡bÄ›r a Ãºpravu vÃ­cestopÃ©ho zÃ¡znamu. Universal Serial Bus â€“ univerzÃ¡lnÃ­ sÃ©riovÃ¡ sbÄ›rnice pro komunikace s perifernÃ­mi zaÅ™Ã­zenÃ­mi. Radio Frequency Universal Asynchronous Receiver/Transmitter â€“ univerzÃ¡lnÃ­ asynchronnÃ­ pÅ™ijÃ­maÄ/vysÃ­laÄ. Light-Emiting Diode â€“ Dioda, kterÃ¡ vyzaÅ™uje viditelnÃ© svÄ›tlo. Most Significant Bit â€“ NejvÃ½znamnÄ›jÅ¡Ã­ bit (vÄ›tÅ¡inou v bajtu). MIDI Show Control â€“ subprotokol pro ovlÃ¡dÃ¡nÃ­ scÃ©nickÃ© techniky, zejmÃ©na pomocÃ­ pÅ™Ã­kazÅ¯ GO, STOP, popÅ™. RESUME. [1] MIDI over Ethernet â€“ MIDI po Ethernetu User Datagram Protocol â€“ jednoduchÃ½ sÃ­Å¥ovÃ½ protokol, kterÃ½ umoÅ¾Åˆuje vÃ½mÄ›nu zprÃ¡v â€host-to-hostâ€œ [4].

DAW

USB

RF UART

LED MSB MSC

MoE UDP

22

Seznam pÅ™Ã­loh
A Tabulky 24 A.1 MIDI status bajty . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24 A.2 MoE znaÄky . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25 B VÃ½pisy kÃ³du 26 B.1 VÃ½pis kÃ³du pro pÅ™Ã­jem a zpracovÃ¡nÃ­ MIDI zprÃ¡vy . . . . . . . . . . . 26 C ZÃ¡znamy z mÄ›Å™enÃ­ latence D Fotografie D.1 Fotografie testovacÃ­ho pÅ™Ã­pravku 27 28 . . . . . . . . . . . . . . . . . . . . 28

23

A
A.1

Tabulky
MIDI status bajty
Tab. A.1: Tabulka MIDI STATUS BAJTÅ® [1]. NÃ¡zev Hex. hodnota 0x8n 0x9n 0xAn 0xBn 0xCn 0xDn 0xEn Bin. hodnota 1000 nnnn 1001 nnnn 1010 nnnn 1011 nnnn 1100 nnnn 1101 nnnn 1110 nnnn

Note-Off Note-On Poly Key Pressure Control Change Program Change Channel Pressure Pitch Bend

Nota vypnuta Nota zapnuta PolyfonickÃ½ tlakovÃ½ ovladaÄ ZmÄ›na kontrolÃ©ru ZmÄ›na programu MonofonickÃ½ tlakovÃ½ ovladaÄ Ohyb vÃ½Å¡ky tÃ³nu

24

A.2

MoE znaÄky
Tab. A.2: Tabulka prvnÃ­ch bajtÅ¯ MoE zprÃ¡v. Bajt . . . 0x08 . . . 0x0E 0x0F Popis Broadcast zprÃ¡va od Å™Ã­dÃ­cÃ­ho PC, kterÃ¡ sonduje ÃºÄastnÃ­ky sÃ­tÄ› Unicast zprÃ¡va od Å™Ã­dÃ­cÃ­ho PC, kterÃ¡ zaÅ™Ã­zenÃ­ maÅ¾e zÃ¡znam z databÃ¡ze subscriptions. Unicast zprÃ¡va od Å™Ã­dÃ­cÃ­ho PC, kterÃ¡ zaÅ™Ã­zenÃ­ vklÃ¡dÃ¡ novÃ½ zÃ¡znam do databÃ¡ze subscriptions, kterÃ½ je obsahem datagramu Unicast odpovÄ›Ä na sondÃ¡Å¾ PC, souÄÃ¡stÃ­ datagramu je i jeden zÃ¡znam databÃ¡ze subscriptions TÅ™Ã­bajtovÃ¡ MIDI zprÃ¡va ZprÃ¡va beacon slouÅ¾Ã­cÃ­ pro upozornÄ›nÃ­ na vlastnÃ­ pÅ™Ã­tomnost

. . . 0x80 . . . 0xA3 . . . 0xFF

25

B
B.1

VÃ½pisy kÃ³du
VÃ½pis kÃ³du pro pÅ™Ã­jem a zpracovÃ¡nÃ­ MIDI zprÃ¡vy
VÃ½pis B.1: VÃ½pis kÃ³du pro pÅ™Ã­jem a zpracovÃ¡nÃ­ MIDI zprÃ¡vy

void handleMIDI () { if ( midiSerial . available () == 3) { _data0 = midiSerial . read (); _data1 = midiSerial . read (); _data2 = midiSerial . read (); sendUDP ( _data0 , _data1 , _data2 ); } } void sendUDP ( byte data0 , byte data1 , byte data2 ) { byte srcCh = data0 & 0 x0F ; for ( byte i = 0; i < MAX_SUBS ; i ++) { if ( srcCh == ( _subscriptions [ i ]. srcdstChannel & 0 xF0 ) >> 4) { data0 = data0 & 0 xF0 ; data0 = data0 | ( _subscriptions [ i ]. srcdstChannel & 0 x0F ); IPAddress destinationIP = Ethernet . localIP (); destinationIP [3] = _subscriptions [ i ]. dstIPnib ; eUDP . beginPacket ( destinationIP , MOE_PORT ); eUDP . write (0 xA3 ); eUDP . write ( data0 ); eUDP . write ( data1 ); eUDP . write ( data2 ); eUDP . endPacket (); } } }

26

C

ZÃ¡znamy z mÄ›Å™enÃ­ latence

Obr. C.1: MÄ›Å™enÃ­ latence pro jeden aktivnÃ­ zÃ¡znam v databÃ¡zi spojenÃ­.

Obr. C.2: MÄ›Å™enÃ­ latence pro Å¡estnÃ¡ct aktivnÃ­ch zÃ¡znamÅ¯ v databÃ¡zi spojenÃ­.

27

D
D.1

Fotografie
Fotografie testovacÃ­ho pÅ™Ã­pravku

Obr. D.1: Fotografie testovacÃ­ho pÅ™Ã­pravku.

28

