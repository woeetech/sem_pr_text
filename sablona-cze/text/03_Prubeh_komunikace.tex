\chapter{Průběh komunikace}
V~této kapitole bude popsán průběh připojení přípravku k síti, automatické rozpoznání a zacházení s přijatými \acs{MIDI} a UDP zprávami.

\section{Připojení k lokální síti}
Každému přípravku byla do prvních šesti bajtů \texttt{EEPROM} paměti uložena unikátní MAC adresa. Při zapnutí a následné inicializaci je adresa načtena a přiřazena. Nejprve proběhne pokus o získání IP adresy pomocí DHCP serveru sítě. V případě neúspěchu použije přípravek uživatelem napevno nastavenou IP adresu. 

Díky knihovně \texttt{EthernetUdp.h} jsou výše zmíněné operace otázkou pouze několika málo řádků:
\lstset{
    frame=single,
    keywordstyle=\color{blue},
    commentstyle=\color{olive},
    basicstyle=\ttfamily\small
    }
\begin{lstlisting}
if (Ethernet.begin())
{
    //DHCP server zdárně přidělil zařízení IP adresu
    Serial.println(Ethernet.localIP());
}
else
{
    Ethernet.begin(_myMac, _userIP);
    //Přidělení IP adresy napevno
    Serial.println(Ethernet.localIP());
}
\end{lstlisting}


\newcommand{\bytes}[4]{
    \begin{center}
        \large{\texttt{0x#1, 0x#2, 0x#3, 0x#4}}
    \end{center}
}



\section{Upozornění na vlastní přítomnost}
Ihned po zdárném připojení k lokální síti je vyslána zpráva  \texttt{beacon}, jejíž účel je upozornit všechna zařízení v lokální síti na vlastní přítomnost. Zpráva se skládá ze čtyř bajtů:
\bytes{FF}{FF}{FF}{FF}
a je poslána na broadcast adresu sítě.

\begin{lstlisting}
_broadcastIP = Ethernet.localIP();
_broadcastIP[3] = 255;
EthernetUdp eUDP;
eUDP.begin(MOE_PORT);
eUDP.beginPacket(_broadcastIP, MOE_PORT);
eUDP.write(_beacon, sizeof(_beacon));
eUDP.endPacket();
\end{lstlisting}

\section{Rozpoznání zařízení na síti}
V případě přijetí zprávy \texttt{beacon} je rozpoznána IP adresa odesílatele a vytvořen nový záznam do databáze spojení \texttt{sub\-scrip\-tions}. V této fázi projektu přípravek napevno přiřazuje kanál 1  lokální příchozí \acs{MIDI} sběrnice kanálu 1 výstupní \acs{MIDI} sběrnice cílového zařízení. V další fázi bude operace přiřazení uskutečňována pravděpodobně přes kontrolní SW na PC připojeného do též sítě.

\begin{lstlisting}
switch(_incomingUDP[0])
{
    //...
    case 0xFF:
        addSubscription(1, eUDP.remoteIP()[3], 1);
    break;
    //...
}
\end{lstlisting}

\section{Přijetí \acs{MIDI} zprávy}\label{chpt:PrijMIDI}
Při přijímání \acs{MIDI} zpráv je nejdříve třeba rozlišit, jedná-li se o zprávou dvoubajtovou, nebo tříbajtovou. Toto lze vyřešit jednoduchým větvením \texttt{switch}. V dalším kroku je nutné dekódovat kanál \acs{MIDI} zprávy z \texttt{DATA BAJTU}~-- tuto \uv{extrakci} lze vyřešit pomocí bitového maskování. Takto získaný bajt je pak porovnáván s prvním nibblem bajtu \texttt{srcdstChannel} každého záznamu databáze \texttt{sub\-scrip\-tions}. Dojde-li ke shodě, začíná konstrukce odchozí zprávy podle dalších informací v odpovídajícím záznamu databáze spojení. Výpis kódu je k dispozici jako příloha \ref{code:handleMIDI}

\section{Přijetí UDP zprávy}
Díky architektuře odesílané zprávy (viz podkapitolu \ref{chpt:PrijMIDI}) je veškeré směrování dokončeno již na straně odesílatele. Přijímač může obdrženou zprávu tedy rovnou poslat do \acs{MIDI} výstupu.



%Nyní je procházena databáze připojení \texttt{sub\-scrip\-tions} a porovnáván první nibble bajtu \texttt{srcdstChannel} každého záznamu s 
