\lstset{
    frame=single,
    keywordstyle=\color{blue},
    commentstyle=\color{olive},
    basicstyle=\ttfamily\small,
    emph={byte},
    emphstyle=\color{blue}
    }

\chapter{Návrh přípravku}
V~rámci semestrální práce byl vytvořen prototyp zařízení na platformě Arduino~UNO, která disponuje čipem ATMEL ATmega 328P. Arduinu sekunduje \linebreak Ethernet~Shield~V1, který je osazen čipem WizNet W5100. 

Přípravek umožňuje výměnu \acs{MIDI} příkazů přes lokální síť, využívá první čtyři vrstvy ISO/OSI modelu. Zároveň poskytuje pokročilé možnosti směrování jednotlivých \acs{MIDI} kanálů.

\section{Hardware}\label{chpt:Schema}
\begin{figure}[h]
    \centering
    \input{schemata/schPrototype}
    \begin{tabular}{l c l c}
        \small
        $R_1$ & $220\,\mathrm{\Omega}$ & $R_2$ & $470\,\mathrm{\Omega}$ \\
        $R_3$ & $10\,\mathrm{k\Omega}$ & $R_4$ & $220\,\mathrm{\Omega}$
    \end{tabular}
    \caption{Schéma prototypu \cite{Indest}} 
    \label{fig:schPrototype}
\end{figure}

Z obr. \ref{fig:schPrototype} je patrné zapojení přípravku. Je využito standardní zapojení \acs{MIDI} vstupu a~výstupu v souladu se schématy na obr.~\ref{fig:schMIDIout} a~\ref{fig:schMIDIin}. Jak již bylo řečeno v kapitole~\ref{chpt:MIDI}, \acs{MIDI} využívá pro komunikaci sériovou linku. V tomto případě je vstupní linka zapojena k~Arduinu na \texttt{pinu~2} a výstupní k~\texttt{pinu~3}\footnote{Arduino umožňuje softwarové přepnutí \texttt{pinů} z režimu výstupu na režim vstup a naopak.}. 

Ve schématu na obr.~\ref{fig:schPrototype} je pro zjednodušení značka \uv{Arduino} chápána jako \uv{Arduino\,+\,Wiznet Shield}.

Přípravek je v~této fázi vývoje napájen skrz \acs{USB} sběrnici Arduina napětím 5\,\unit{V}. 

%...%

\section{Software}
Software přípravku byl vyvíjen za účelem maximalizace variability směřování \acs{MIDI} příkazů. Na funkční rovině je inspirován systémem \emph{Dante}, který se používá pro přenos zvukového signálu přes počítačovou síť. \emph{Dante} umožňuje pokročilé směřování signálů napříč síťovými zařízeními, ovládané pomocí přehledné matice na kontrolním PC. Do této fáze by měl být vyvinut i systém \acs{MoE}\footnote{\acl{MoE}}.
%Pro spolehlivou komunikaci mezi zařízeními bylo třeba vyvinout protokol, který bude zapouzdřovat a směřovat samotné \acs{MIDI} zprávy. S tímto cílem byl implementován protokol \acs{MoE}\footnote{\acl{MoE}}. 
\subsection{Databáze spojení}
S cílem docílit již zmiňované velké variability ve směřování zpráv napříč přípravky byla do zdrojového kódu implementována tzv. databáze spojení \texttt{sub\-scrip\-tions[]}:
\begin{lstlisting}
typedef struct subscription
{
    byte srcdstChannel;
    byte dstIPnib;
} _subscriptions[MAX_SUBS];
\end{lstlisting}
Toto pole struktur \texttt{subscription} je pro celý \acs{MoE} protokol zásadní. Jedno \uv{spojení}, tedy jeden prvek v tomto poli, propojuje jeden \acs{MIDI} kanál lokálního zařízení s jedním \acs{MIDI} kanálem cílového zařízení. Toto pole si lze představit jako virtuální patchbay. Jeden patch-kabel odpovídá jednomu prvku v poli (záznamu v databázi). 

Každý záznam je tvořen dvěma bajty:
\begin{itemize}
    \item \texttt{srcdstChannel}: v sobě kóduje zdrojový \acs{MIDI} kanál, který se týká lokálního zařízení, a cílový \acs{MIDI} kanál~-- ten se týká zařízení cílového. \uv{Kódování} je uskutečněno následujícím způsobem:
    \begin{figure}[h]
        \centering
        \begin{tabular}{|c|c|c|c|c|c|c|c|}
            \hline
            \multicolumn{8}{|c|}{\texttt{srcdstChannel}} \\
            \hline
            0 & 1 & 1 & 0 & 1 & 0 & 1 & 1 \\
            \hline 
            \multicolumn{4}{c}{\upbracefill} & \multicolumn{4}{c}{\upbracefill} \\
            \multicolumn{4}{c}{\footnotesize zdroj} & \multicolumn{4}{c}{\footnotesize cíl} \\
        \end{tabular}
        \caption{}
        \label{}
    \end{figure}
    \item \texttt{dstIPnib}:
\end{itemize}
\subsection{Logická vrstva}

Jedna \acs{MoE} zpráva obsahuje \emph{čtyři bajty}. První bajt určuje 





